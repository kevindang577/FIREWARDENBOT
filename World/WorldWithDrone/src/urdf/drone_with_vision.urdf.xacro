<?xml version="1.0"?>
<robot name="firewardenbot_drone" xmlns:xacro="http://ros.org/wiki/xacro">
  
  <xacro:include filename="$(find 41068_ignition_bringup)/urdf/common_properties.urdf.xacro"/>
  <xacro:include filename="$(find 41068_ignition_bringup)/urdf/camera_sensors.urdf.xacro"/>

  <!-- Drone base properties -->
  <xacro:property name="drone_mass" value="2.5"/>
  <xacro:property name="drone_size" value="0.4"/>
  <xacro:property name="rotor_radius" value="0.1"/>
  <xacro:property name="rotor_mass" value="0.05"/>

  <!-- Base link (drone body) -->
  <link name="base_link">
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="${drone_size} ${drone_size} 0.1"/>
      </geometry>
      <material name="drone_body">
        <color rgba="0.2 0.2 0.2 1.0"/>
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="${drone_size} ${drone_size} 0.1"/>
      </geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="${drone_mass}"/>
      <inertia ixx="0.0347563" ixy="0" ixz="0" iyy="0.0458929" iyz="0" izz="0.0977"/>
    </inertial>
  </link>

  <!-- Rotor links and joints -->
  <xacro:macro name="rotor" params="rotor_id direction x y">
    <link name="rotor_${rotor_id}">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="${rotor_radius}" length="0.01"/>
        </geometry>
        <material name="rotor_material">
          <color rgba="0.1 0.1 0.1 0.7"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="${rotor_radius}" length="0.01"/>
        </geometry>
      </collision>
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="${rotor_mass}"/>
        <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
      </inertial>
    </link>

    <joint name="rotor_${rotor_id}_joint" type="continuous">
      <parent link="base_link"/>
      <child link="rotor_${rotor_id}"/>
      <origin xyz="${x} ${y} 0.06" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    <!-- Gazebo rotor plugin -->
    <gazebo reference="rotor_${rotor_id}">
      <material>Gazebo/DarkGrey</material>
    </gazebo>
  </xacro:macro>

  <!-- Four rotors -->
  <xacro:rotor rotor_id="0" direction="ccw" x="0.15" y="0.15"/>
  <xacro:rotor rotor_id="1" direction="cw" x="-0.15" y="0.15"/>
  <xacro:rotor rotor_id="2" direction="ccw" x="-0.15" y="-0.15"/>
  <xacro:rotor rotor_id="3" direction="cw" x="0.15" y="-0.15"/>

  <!-- Computer Vision Sensors for Drone -->
  
  <!-- Main downward-facing camera for fire detection -->
  <xacro:rgb_camera name="drone_camera" parent_link="base_link" 
                   xyz="0 0 -0.1" rpy="0 1.57 0"/>
  
  <!-- Thermal camera for heat signature detection -->
  <xacro:thermal_camera name="drone_thermal_camera" parent_link="base_link" 
                       xyz="0.05 0 -0.1" rpy="0 1.57 0"/>
  
  <!-- Forward-facing camera for navigation -->
  <xacro:rgb_camera name="drone_nav_camera" parent_link="base_link" 
                   xyz="0.1 0 0" rpy="0 0 0"/>
  
  <!-- Stereo cameras for obstacle avoidance -->
  <xacro:rgb_camera name="drone_camera_left" parent_link="base_link" 
                   xyz="0.08 0.03 0" rpy="0 0 0"/>
  <xacro:rgb_camera name="drone_camera_right" parent_link="base_link" 
                   xyz="0.08 -0.03 0" rpy="0 0 0"/>

  <!-- Wide-angle surveillance camera -->
  <xacro:rgb_camera name="drone_wide_camera" parent_link="base_link" 
                   xyz="0 0 -0.12" rpy="0 1.7 0"/>

  <!-- LiDAR for 3D mapping -->
  <xacro:lidar_camera name="drone_lidar" parent_link="base_link" 
                     xyz="0 0 0.08" rpy="0 0 0"/>

  <!-- Gazebo plugins -->
  <gazebo>
    <!-- Multirotor motor model -->
    <plugin filename="libignition-gazebo-multicopter-motor-model-system.so" 
            name="ignition::gazebo::systems::MulticopterMotorModel">
      <robotNamespace></robotNamespace>
      <jointName>rotor_0_joint</jointName>
      <linkName>rotor_0</linkName>
      <turningDirection>ccw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>1500</maxRotVelocity>
      <motorConstant>5.84e-06</motorConstant>
      <momentConstant>0.06</momentConstant>
      <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>0</motorNumber>
      <rotorDragCoefficient>0.000175</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>/motor_speed/0</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
    </plugin>

    <plugin filename="libignition-gazebo-multicopter-motor-model-system.so" 
            name="ignition::gazebo::systems::MulticopterMotorModel">
      <robotNamespace></robotNamespace>
      <jointName>rotor_1_joint</jointName>
      <linkName>rotor_1</linkName>
      <turningDirection>cw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>1500</maxRotVelocity>
      <motorConstant>5.84e-06</motorConstant>
      <momentConstant>0.06</momentConstant>
      <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>1</motorNumber>
      <rotorDragCoefficient>0.000175</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>/motor_speed/1</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
    </plugin>

    <plugin filename="libignition-gazebo-multicopter-motor-model-system.so" 
            name="ignition::gazebo::systems::MulticopterMotorModel">
      <robotNamespace></robotNamespace>
      <jointName>rotor_2_joint</jointName>
      <linkName>rotor_2</linkName>
      <turningDirection>ccw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>1500</maxRotVelocity>
      <motorConstant>5.84e-06</motorConstant>
      <momentConstant>0.06</momentConstant>
      <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>2</motorNumber>
      <rotorDragCoefficient>0.000175</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>/motor_speed/2</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
    </plugin>

    <plugin filename="libignition-gazebo-multicopter-motor-model-system.so" 
            name="ignition::gazebo::systems::MulticopterMotorModel">
      <robotNamespace></robotNamespace>
      <jointName>rotor_3_joint</jointName>
      <linkName>rotor_3</linkName>
      <turningDirection>cw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>1500</maxRotVelocity>
      <motorConstant>5.84e-06</motorConstant>
      <momentConstant>0.06</momentConstant>
      <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>3</motorNumber>
      <rotorDragCoefficient>0.000175</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>/motor_speed/3</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
    </plugin>

    <!-- Multicopter control -->
    <plugin filename="libignition-gazebo-multicopter-control-system.so" 
            name="ignition::gazebo::systems::MulticopterVelocityControl">
      <robotNamespace></robotNamespace>
      <commandSubTopic>/cmd_vel</commandSubTopic>
      <motorControlPubTopic>/gazebo/command/motor_speed</motorControlPubTopic>
      <enableSubTopic>/enable_motors</enableSubTopic>
      <comLinkName>base_link</comLinkName>
      <velocityGain>2.7 2.7 2.7</velocityGain>
      <attitudeGain>3.0 3.0 0.15</attitudeGain>
      <angularRateGain>0.52 0.52 0.025</angularRateGain>
      <maximumLinearAcceleration>2 2 2</maximumLinearAcceleration>
      <maximumLinearVelocity>5 5 5</maximumLinearVelocity>
      <maximumAngularVelocity>3 3 3</maximumAngularVelocity>
      <linearVelocityNoiseMean>0 0 0</linearVelocityNoiseMean>
      <linearVelocityNoiseStdDev>0.1 0.1 0.1</linearVelocityNoiseStdDev>
      <angularVelocityNoiseMean>0 0 0</angularVelocityNoiseMean>
      <angularVelocityNoiseStdDev>0.05 0.05 0.05</angularVelocityNoiseStdDev>
    </plugin>

    <!-- IMU sensor -->
    <plugin filename="libignition-gazebo-imu-system.so" name="ignition::gazebo::systems::Imu">
    </plugin>
  </gazebo>

  <!-- IMU link -->
  <link name="imu_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.001"/>
      <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6"/>
    </inertial>
  </link>

  <joint name="imu_joint" type="fixed">
    <parent link="base_link"/>
    <child link="imu_link"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <!-- Gazebo IMU sensor -->
  <gazebo reference="imu_link">
    <sensor type="imu" name="imu_sensor">
      <always_on>1</always_on>
      <update_rate>100</update_rate>
      <visualize>true</visualize>
      <plugin filename="libignition-gazebo-imu-system.so" name="ignition::gazebo::systems::Imu">
      </plugin>
    </sensor>
  </gazebo>

</robot>
